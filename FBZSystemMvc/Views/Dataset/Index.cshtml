@model FBZSystemMvc.Models.DatasetIndexViewModel
@{
    ViewData["Title"] = "Dataset Search";
}

<h1>Dataset Search</h1>

<form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
        <label class="form-label">Title contains</label>
        <input class="form-control" name="TitleContains" value="@Model.Query.TitleContains" />
    </div>

    <div class="col-md-4">
        <label class="form-label">Author contains</label>
        <input class="form-control" name="AuthorContains" value="@Model.Query.AuthorContains" />
    </div>

    <div class="col-md-4">
        <label class="form-label">Genre</label>
        <input class="form-control" name="Genre" value="@Model.Query.Genre" />
    </div>

    <div class="col-md-2">
        <label class="form-label">Year from</label>
        <input class="form-control" type="number" name="YearFrom" value="@(Model.Query.YearFrom?.ToString() ?? "")" />
    </div>

    <div class="col-md-2">
        <label class="form-label">Year to</label>
        <input class="form-control" type="number" name="YearTo" value="@(Model.Query.YearTo?.ToString() ?? "")" />
    </div>

    <div class="col-md-3">
        <label class="form-label">Language</label>
        <input class="form-control" name="Language" value="@Model.Query.Language" />
    </div>

    <div class="col-md-3">
        <label class="form-label">Edition</label>
        <input class="form-control" name="Edition" value="@Model.Query.Edition" />
    </div>

    <div class="col-md-2">
        <label class="form-label">Group by</label>
        <select class="form-select" name="GroupBy">
            <option value="None" selected="@(Model.Query.GroupBy == "None")">None</option>
            <option value="Author" selected="@(Model.Query.GroupBy == "Author")">Author</option>
            <option value="Year" selected="@(Model.Query.GroupBy == "Year")">Year</option>
        </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="SortDescending" value="true" @(Model.Query.SortDescending ? "checked" : "") />
            <label class="form-check-label">Sort Z–A</label>
        </div>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <div>
            <label class="form-label">Page size</label>
            <select class="form-select" name="PageSize">
                <option value="25" selected="@(Model.Query.PageSize == 25)">25</option>
                <option value="50" selected="@(Model.Query.PageSize == 50)">50</option>
                <option value="100" selected="@(Model.Query.PageSize == 100)">100</option>
            </select>
        </div>
    </div>

    <div class="col-12">
        <button class="btn btn-primary" type="submit">Search</button>
        <a class="btn btn-outline-secondary" href="/Dataset?Page=1&PageSize=50">Reset</a>
    </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-2">
    <p class="mb-0">
        <strong>@Model.TotalResults</strong> result(s)
        — Page <strong>@Model.Query.Page</strong> of <strong>@Model.TotalPages</strong>
    </p>

    <form method="get" class="d-flex gap-2">
        @* preserve current filters *@
        <input type="hidden" name="TitleContains" value="@Model.Query.TitleContains" />
        <input type="hidden" name="AuthorContains" value="@Model.Query.AuthorContains" />
        <input type="hidden" name="Genre" value="@Model.Query.Genre" />
        <input type="hidden" name="YearFrom" value="@(Model.Query.YearFrom?.ToString() ?? "")" />
        <input type="hidden" name="YearTo" value="@(Model.Query.YearTo?.ToString() ?? "")" />
        <input type="hidden" name="Language" value="@Model.Query.Language" />
        <input type="hidden" name="Edition" value="@Model.Query.Edition" />
        <input type="hidden" name="GroupBy" value="@Model.Query.GroupBy" />
        @if (Model.Query.SortDescending)
        {
            <input type="hidden" name="SortDescending" value="true" />
        }
        <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

        <button class="btn btn-outline-primary" type="submit" name="Page" value="@(Math.Max(1, Model.Query.Page - 1))"
                @(Model.Query.Page <= 1 ? "disabled" : "")>
            Prev
        </button>

        <button class="btn btn-outline-primary" type="submit" name="Page" value="@(Math.Min(Model.TotalPages, Model.Query.Page + 1))"
                @(Model.Query.Page >= Model.TotalPages ? "disabled" : "")>
            Next
        </button>
    </form>
</div>

            <ul class="list-group list-group-flush mt-3">
                @foreach (var item in Model.SearchList)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@item.MainTitle</span>

                        <form method="post" action="/Dataset/RemoveFromList" class="m-0">
                            <input type="hidden" name="id" value="@item.Id" />

                            @* preserve current filters *@
                            <input type="hidden" name="TitleContains" value="@Model.Query.TitleContains" />
                            <input type="hidden" name="AuthorContains" value="@Model.Query.AuthorContains" />
                            <input type="hidden" name="Genre" value="@Model.Query.Genre" />
                            <input type="hidden" name="YearFrom" value="@(Model.Query.YearFrom?.ToString() ?? "")" />
                            <input type="hidden" name="YearTo" value="@(Model.Query.YearTo?.ToString() ?? "")" />
                            <input type="hidden" name="Language" value="@Model.Query.Language" />
                            <input type="hidden" name="Edition" value="@Model.Query.Edition" />
                            <input type="hidden" name="GroupBy" value="@Model.Query.GroupBy" />
                            @if (Model.Query.SortDescending)
                            {
                                <input type="hidden" name="SortDescending" value="true" />
                            }
                            <input type="hidden" name="Page" value="@Model.Query.Page" />
                            <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

                            <button class="btn btn-sm btn-outline-secondary" type="submit">Remove</button>
                        </form>
                    </li>
                }
            </ul>
        </div>
    </div>
}

@if (Model.SearchList is not null && Model.SearchList.Count > 0)
{
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Search List (@Model.SearchList.Count)</h5>

                <form method="post" action="/Dataset/ClearList" class="m-0">
                    <input type="hidden" name="TitleContains" value="@Model.Query.TitleContains" />
                    <input type="hidden" name="AuthorContains" value="@Model.Query.AuthorContains" />
                    <input type="hidden" name="Genre" value="@Model.Query.Genre" />
                    <input type="hidden" name="YearFrom" value="@(Model.Query.YearFrom?.ToString() ?? "")" />
                    <input type="hidden" name="YearTo" value="@(Model.Query.YearTo?.ToString() ?? "")" />
                    <input type="hidden" name="Language" value="@Model.Query.Language" />
                    <input type="hidden" name="Edition" value="@Model.Query.Edition" />
                    <input type="hidden" name="GroupBy" value="@Model.Query.GroupBy" />
                    @if (Model.Query.SortDescending)
                    {
                        <input type="hidden" name="SortDescending" value="true" />
                    }
                    <input type="hidden" name="Page" value="@Model.Query.Page" />
                    <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

                    <button class="btn btn-sm btn-outline-danger" type="submit">Clear</button>
                </form>
            </div>

            <ul class="list-group list-group-flush mt-3">
                @foreach (var item in Model.SearchList)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@item.MainTitle</span>

                        <form method="post" action="/Dataset/RemoveFromList" class="m-0">
                            <input type="hidden" name="id" value="@item.Id" />

                            <input type="hidden" name="TitleContains" value="@Model.Query.TitleContains" />
                            <input type="hidden" name="AuthorContains" value="@Model.Query.AuthorContains" />
                            <input type="hidden" name="Genre" value="@Model.Query.Genre" />
                            <input type="hidden" name="YearFrom" value="@(Model.Query.YearFrom?.ToString() ?? "")" />
                            <input type="hidden" name="YearTo" value="@(Model.Query.YearTo?.ToString() ?? "")" />
                            <input type="hidden" name="Language" value="@Model.Query.Language" />
                            <input type="hidden" name="Edition" value="@Model.Query.Edition" />
                            <input type="hidden" name="GroupBy" value="@Model.Query.GroupBy" />
                            @if (Model.Query.SortDescending)
                            {
                                <input type="hidden" name="SortDescending" value="true" />
                            }
                            <input type="hidden" name="Page" value="@Model.Query.Page" />
                            <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

                            <button class="btn btn-sm btn-outline-secondary" type="submit">Remove</button>
                        </form>
                    </li>
                }
            </ul>
        </div>
    </div>
}


<table class="table table-sm table-striped align-middle">
    <thead>
        <tr>
            <th>Title</th>
            <th>Authors</th>
            <th>Years</th>
            <th>Genres</th>
            <th>ISBNs</th>
            <th class="text-end">Actions</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var c in Model.Results)
    {
        <tr>
            <td>@c.MainTitle</td>
            <td>@string.Join(", ", c.Authors.Take(3))@(c.Authors.Count > 3 ? "…" : "")</td>
            <td>@(c.Years.Count == 0 ? "" : string.Join(", ", c.Years.OrderBy(y => y)))</td>
            <td>@string.Join(", ", c.Genres.Take(3))@(c.Genres.Count > 3 ? "…" : "")</td>
            <td>@string.Join(", ", c.Isbns.Take(2))@(c.Isbns.Count > 2 ? "…" : "")</td>
            <td class="text-end">
                <form method="post" action="/Dataset/AddToList" style="display:inline">
                    <input type="hidden" name="id" value="@c.Id" />

                    @* preserve current filters *@
                    <input type="hidden" name="TitleContains" value="@Model.Query.TitleContains" />
                    <input type="hidden" name="AuthorContains" value="@Model.Query.AuthorContains" />
                    <input type="hidden" name="Genre" value="@Model.Query.Genre" />
                    <input type="hidden" name="YearFrom" value="@(Model.Query.YearFrom?.ToString() ?? "")" />
                    <input type="hidden" name="YearTo" value="@(Model.Query.YearTo?.ToString() ?? "")" />
                    <input type="hidden" name="Language" value="@Model.Query.Language" />
                    <input type="hidden" name="Edition" value="@Model.Query.Edition" />
                    <input type="hidden" name="GroupBy" value="@Model.Query.GroupBy" />
                    @if (Model.Query.SortDescending)
                    {
                        <input type="hidden" name="SortDescending" value="true" />
                    }
                    <input type="hidden" name="Page" value="@Model.Query.Page" />
                    <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

                    <button class="btn btn-sm btn-outline-primary" type="submit">Add</button>
                </form>
            </td>
        </tr>
    }
    </tbody>
</table>
